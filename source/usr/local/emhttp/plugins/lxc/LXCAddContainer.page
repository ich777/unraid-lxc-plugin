Title="Add LXC Container"
Markdown="false"
---
<link rel="stylesheet" href="/plugins/lxc/css/lxc.css">
<script src="<?autov('/webGui/javascript/jquery.switchbutton.js')?>"></script>
<script src="<?autov('/plugins/lxc/js/lxc.js')?>"></script>

<?php
require_once '/usr/local/emhttp/plugins/lxc/include/Settings.php';
$settings = new Settings();

$started = $var['fsState'] == 'Started';
$macaddress = getNewMacAddress();

// Get images from linuxcontainers.org
downloadLXCproducts('http://images.linuxcontainers.org/meta/simplestreams/v1/index.json');

// Filter out only products from json
$json_data = file_get_contents("/tmp/lxc/images.linuxcontainers.org.json");
$json_data = json_decode($json_data, true);
$json_data = json_encode($json_data['index']['images']['products']);
$json_data = json_decode($json_data, true);


$avail_images = [];

foreach ($json_data as $item) {
    list($distribution, $release, $architecture, $type) = explode(':', $item);
    
    $avail_images[$distribution][$release][$architecture][$type] = true;
}

$avail_images_json = json_encode($avail_images);

?>



<script>
  //Create VNC container box
  function createVNCContainer(form) {
    var name = form.VNCcontName.value;
    openBox("/usr/local/emhttp/plugins/lxc/include/create_vnc_container.sh&arg1=<?php echo $settings->default_path; ?>&arg2=" + name, "Create VNC Container", 600, 800, true);
    return false;
  }
</script>

<div id="canvas">
<?php if (empty($json_data)) { ?>
  <form id="addContainer" autocomplete="off">
    <div class="">
      <dl>
        <dt>Container Name:</dt>
        <dd><input type="text" name="contName" pattern="[a-zA-Z0-9][a-zA-Z0-9_.-]+" required value="DebianLXC">
        </dd>
      </dl>
    </div>

    <div class="">
      <dl>
        <dt>Distribution:</dt>
        <dd><input type="text" name="contDistribution" pattern="[a-zA-Z0-9][a-zA-Z0-9_.-]+"
                   style="text-transform:lowercase" required="true" value="debian"> You can get a full list of available
          container images <a title=" Linux Containers - Image server" href="https://uk.lxd.images.canonical.com/"
                              target="_blank">HERE</a></dd>
      </dl>
    </div>

    <div class="">
      <dl>
        <dt>Release:</dt>
        <dd><input type="text" name="contRelease" pattern="[a-zA-Z0-9_.-]+" style="text-transform:lowercase" required="true" value="bullseye"></dd>
      </dl>
    </div>

<?php } else { ?>
  <form id="addContainer" autocomplete="off">
    <div class="">
      <dl>
        <dt>Container Name:</dt>
        <dd><input type="text" name="contName" pattern="[a-zA-Z0-9][a-zA-Z0-9_.-]+" required placeholder="Container Name">
        </dd>
      </dl>
    </div>

    <div class="">
      <dl>
        <dt>Distribution:</dt>
        <dd><select id="distribution-select" name="contDistribution" required>
        <option name="contDistribution" value="">Select a Distribution</option>
        <?php foreach ($avail_images as $distribution => $releases) : ?>
        <option value="<?= $distribution ?>"><?= $distribution ?></option>
        <?php endforeach; ?></select></dd>
      </dl>
    </div>

    <div class="">
      <dl>
        <dt>Release:</dt>
        <dd><select name="contRelease" id="release-select" required></select></dd>
      </dl>
    </div>
<?php } ?>

    <div class="">
      <dl>
        <dt>Mac Address:</dt>
        <dd style="display: grid;">
          <input type="text" name="contMac" required="true" id="mac" style="text-transform:uppercase" value="<?= getNewMacAddress(); ?>">
          <div id="emac" class="emac">Invalid MAC address</div>
        </dd>

      </dl>
    </div>

    <div class="">
      <dl>
        <dt>Autostart:</dt>
        <dd><input type="checkbox" name="contAutostart" checked></dd>
      </dl>
    </div>

    <input type="submit" value="_(Create)_">
    <a href="LXC" class="button">Done</a>

  </form>
</div>


<div id="title">
  <span class="left"></span>
</div>

<form method="post" autocomplete="off">

  <div class="">
    <dl>
      <dt>VNC Container Name:</dt>
      <dd>
        <input type="text" name="VNCcontName" pattern="[a-zA-Z0-9][a-zA-Z0-9_.-]+" value="DebianVNC">
        <input type="button" value="_(Create VNC Container)_" onclick="createVNCContainer(this.form)">
      </dd>
    </dl>

  </div>
</form>

<script>
var avail_images = <?= $avail_images_json ?>;
var distributionSelect = document.getElementById("distribution-select");
var releaseSelect = document.getElementById("release-select");

var defaultOption = document.createElement("option");
defaultOption.value = "";
defaultOption.text = "Select a Release";
releaseSelect.add(defaultOption);
releaseSelect.disabled = true;

distributionSelect.addEventListener("change", function() {
  var distribution = this.value;
  releaseSelect.disabled = false;

  while (releaseSelect.firstChild) {
    releaseSelect.removeChild(releaseSelect.firstChild);
  }

  if (distribution !== "") {
    var releases = Object.keys(avail_images[distribution]);
    releases.forEach(function(release) {
      var option = document.createElement("option");
      option.value = release;
      option.text = release;
      releaseSelect.add(option);
    });
  }
});
</script>
